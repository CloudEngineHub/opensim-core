# Temporary hack to package dependencies on Linux.
# the macro names are kept similar to mac osx despite using 
# patchelf instead of otool (which is not available on linux)
# for ease of comparison maintenance. Same with commented lines
#
set(libdir "@CMAKE_INSTALL_PREFIX@/@CMAKE_INSTALL_LIBDIR@")
message(STATUS "Editing RPATH of tropter dependency libraries")

macro(install_name_tool_add_rpath lib)
    execute_process(COMMAND patchelf
            --set-rpath "$ORIGIN"
            "${libdir}/lib${lib}")
    message(STATUS "patchelf --add-rpath ORIGIN to ${libdir}/lib${lib}")
endmacro()

macro(install_name_tool_delete_rpath lib rpath)
    execute_process(COMMAND patchelf
            --remove-rpath ${rpath}
            "${libdir}/lib${lib}")
endmacro()

# Get the directory containing libgcc_s.1.dylib.
# otool: Get the list of dependencies of gfortran, which includes libgcc_s.
# grep: Isolate the line containing libgcc.
# perl: Extract only the directory, without the filename.
#    ^\\s+     matches all spaces at the start of the string.
#   (.*)       matches everything up to libgcc, and captures it as match gorup #1
#   \\/libg.*  matches the rest of the line.
#   \\1        replaces the contents of the entire match with match group #1
#execute_process(COMMAND bash "-c"
#    "otool -L ${libdir}/libgfortran.dylib | grep 'libgcc' | perl -pe 's/^\\s+(.*)\\/libg.*/\\1/gc'"
#    OUTPUT_VARIABLE libgcc_dir
#    OUTPUT_STRIP_TRAILING_WHITESPACE)

# tropter
#install_name_tool_change(tropter adolc.2 "@ADOLC_DIR@/lib64")
#install_name_tool_change(tropter ipopt.1 "@IPOPT_LIBDIR@")
#install_name_tool_change(tropter coinmumps.1 "@IPOPT_LIBDIR@")
#install_name_tool_change(tropter coinmetis.1 "@IPOPT_LIBDIR@")
#install_name_tool_change_gfortran(tropter)
#install_name_tool_change_quadmath(tropter)
install_name_tool_add_rpath(tropter.so)

# adol-c
#install_name_tool_id(adolc.2)
install_name_tool_add_rpath(adolc.so.2.1.0)
install_name_tool_add_rpath(adolc.so)
install_name_tool_add_rpath(adolc.so.2)
#install_name_tool_delete_rpath(adolc.2 "@ColPack_ROOT_DIR@/lib")


